cd /opt/airflow2/dags
grep -RIl "airflow\.operators\.sensors" . | xargs -r sed -i \
's/from\s\+airflow\.operators\.sensors\s\+import\s\+ExternalTaskSensor/from airflow.sensors.external_task import ExternalTaskSensor/g'

for s in webserver scheduler worker triggerer; do
  podman exec -it airflow2_${s}_1 pip install \
    "apache-airflow-providers-ssh" \
    "apache-airflow-providers-mysql" \
    "apache-airflow-providers-http"
done


podman exec -it airflow2_webserver_1 bash -lc \
'python -m pip install --user apache-airflow-providers-ssh apache-airflow-providers-mysql apache-airflow-providers-http'


for s in webserver scheduler worker triggerer; do
  podman exec -it airflow2_${s}_1 bash -lc \
  'python -m pip install --user apache-airflow-providers-ssh apache-airflow-providers-mysql apache-airflow-providers-http'
done


grep -Rn "from[[:space:]]\+airflow\.operators\.sensors[[:space:]]\+import[[:space:]]\+ExternalTaskSensor" /opt/airflow2/dags

sed -i.bak \
's/from[[:space:]]\+airflow\.operators\.sensors[[:space:]]\+import[[:space:]]\+ExternalTaskSensor/from airflow.sensors.external_task import ExternalTaskSensor/g' \
/opt/airflow2/dags/*.py

podman-compose restart scheduler webserver


grep -RIn "conn_id" /opt/airflow2/dags | sed -E 's/.*conn_id[=: ]+["'\'']([^"'\'' ]+)["'\''].*/\1/' | sort -u

mysql -h trmq01.ny2 -u airflow_ufact -p -D ufactairflow \
  -e "SELECT conn_id, conn_type, host, schema, login, password, port, extra
      FROM connection WHERE conn_id='ssh_factapps_app01'\G"



sudo dnf install -y mariadb-server
sudo systemctl enable --now mariadb
sudo mysql_secure_installation


sudo sed -i 's/^\(\s*bind-address\s*=\s*\).*/\10.0.0.0/' /etc/my.cnf.d/mariadb-server.cnf || true
# Agar line na mile to is section me add kar do:
# [mysqld]
# bind-address=0.0.0.0
sudo systemctl restart mariadb



mysql -u root -p


CREATE DATABASE ufactairflow CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

CREATE USER 'airflow_ufact'@'%' IDENTIFIED BY 'Admin@123';
GRANT ALL PRIVILEGES ON ufactairflow.* TO 'airflow_ufact'@'%';

FLUSH PRIVILEGES;
EXIT;


mysql -h <DB_SERVER_IP> -u airflow_ufact -p -e "SELECT 1;" ufactairflow
# password: Admin@123

msg_rmq: amqp://airflow:Admin@123@<RABBITMQ_IP>:5672/
sql_alchemy_conn: mysql+mysqldb://airflow:<MYSQL_PASSWORD>@<MYSQL_IP>:3306/airflow


# 1) Fernet key
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"

# 2) Webserver secret key
python -c "import secrets; print(secrets.token_urlsafe(32))"


CREATE USER IF NOT EXISTS 'airflow'@'airflow01.ufact.ny2.eexchange.com' IDENTIFIED BY 'airflow';
GRANT ALL PRIVILEGES ON airflow.* TO 'airflow'@'airflow01.ufact.ny2.eexchange.com';
FLUSH PRIVILEGES;

CREATE DATABASE airflow;
GRANT ALL PRIVILEGES ON airflow.* TO 'airflow'@'airflow01.ufact.ny2.eexchange.com';
FLUSH PRIVILEGES;

podman-compose up -d airflow-scheduler airflow-triggerer airflow-worker airflow-webserver flower

